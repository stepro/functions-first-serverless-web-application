#!/bin/bash

LANGUAGE=csharp
if [ "$COMPOSE_FILE" == "azure-compose.js.yaml" ]; then
  LANGUAGE=javascript
fi

#
# PHASE 0: BUILD
#

build-frontend() {
  echo Building \'frontend\' in \'www\'...
  cd www
  npm install
  npm run generate
  cd ..
}

# build-frontend

#
# PHASE 1: CREATE
#

PROPS=$(mktemp -d)
trap 'rm -rf $PROPS' EXIT

NAME_analyzer=analyzer-$(hash cognitiveservices/account/analyzer@$LOCATION)
create-analyzer() {
  NAME="$NAME_analyzer"
  echo Creating \'analyzer\' as cognitive services account \'$NAME\'...
  local START_TIME=$(date +%s)
  STDERR_FILTER=("Microsoft will use ")
  echo PROP_analyzer_url=$(azp analyzer cognitiveservices account create \
    -n "$NAME" \
    -g "$RESOURCE_GROUP" \
    -l "$LOCATION" \
    --kind ComputerVision \
    --sku F0 \
    --yes \
    --query endpoint \
    -o tsv) >> $PROPS/analyzer
  echo PROP_analyzer_key=$(azp analyzer cognitiveservices account keys list \
    -n "$NAME" \
    -g "$RESOURCE_GROUP" \
    --query key1 \
    -o tsv) >> $PROPS/analyzer
  echo Created \'analyzer\' as cognitive services account \'$NAME\' in $(since $START_TIME)
}

NAME_default_functionapp=default-$(hash functionapp/default@$LOCATION)
create-default-functionapp() {
  NAME="$NAME_default_functionapp"
  echo Creating default function app \'$NAME\'...
  local START_TIME=$(date +%s)
  echo PROP_default_functionapp_defaultHostName=$(azp +functionapp functionapp create \
    -n "$NAME" \
    -g "$RESOURCE_GROUP" \
    -c "$LOCATION" \
    -s "$NAME_default_storageAccount" \
    --query defaultHostName \
    -o tsv) >> $PROPS/default_functionapp
  echo Created default function app \'$NAME\' in $(since $START_TIME)
}

NAME_default_storageAccount=default$(hash storage/account/default@$LOCATION)
create-default-storageAccount() {
  NAME="$NAME_default_storageAccount"
  echo Creating default storage account \'$NAME\'...
  local START_TIME=$(date +%s)
  azp -q +storageAccount storage account create \
    -n "$NAME" \
    -g "$RESOURCE_GROUP" \
    -l "$LOCATION" \
    --kind StorageV2 \
    --https-only \
    --sku Standard_LRS
  # TODO: move these rules elsewhere
  azp -q +storageAccount storage cors clear \
    --account-name "$NAME" \
    --services b
  azp -q +storageAccount storage cors add \
    --account-name "$NAME" \
    --services b \
    --methods OPTIONS PUT \
    --origins '*' \
    --allowed-headers '*' \
    --exposed-headers '*'
  PRIMARY_BLOB_ENDPOINT=$(azp +storageAccount storage account show \
    -n "$NAME" \
    -g "$RESOURCE_GROUP" \
    --query primaryEndpoints.blob \
    -o tsv)
  echo PROP_default_storageAccount_primaryEndpoints_blob=$(echo $PRIMARY_BLOB_ENDPOINT | sed 's/\/$//') >> $PROPS/default_storageAccount
  echo PROP_default_storageAccount_connectionString=$(azp +storageAccount storage account show-connection-string \
    -n "$NAME" \
    -g "$RESOURCE_GROUP" \
    --query connectionString \
    -o tsv) >> $PROPS/default_storageAccount
  echo Created default storage account \'$NAME\' in $(since $START_TIME)
}

create-frontend() {
  echo Creating \'frontend\' as static website in storage account \'$NAME_default_storageAccount\'...
  local START_TIME=$(date +%s)
  azp -q frontend storage blob service-properties update \
    --account-name "$NAME_default_storageAccount" \
    --static-website
  PRIMARY_ENDPOINT=$(azp frontend storage account show \
    -n "$NAME_default_storageAccount" \
    -g "$RESOURCE_GROUP" \
    --query primaryEndpoints.web \
    -o tsv)
  echo PROP_frontend_primaryEndpoint=$(echo $PRIMARY_ENDPOINT | sed 's/\/$//') >> $PROPS/frontend
  echo PROP_frontend_account_connectionString="$PROP_default_storageAccount_connectionString" >> $PROPS/frontend
  echo Created \'frontend\' as static website in storage account \'$NAME_default_storageAccount\' in $(since $START_TIME)
}

NAME_GetImages=GetImages
create-GetImages() {
  NAME="$NAME_GetImages"
  echo Creating \'GetImages\' as function \'$NAME\' in function app \'$NAME_default_functionapp\'...
  local START_TIME=$(date +%s)
  echo PROP_GetImages_app_defaultHostName="$PROP_default_functionapp_defaultHostName" >> $PROPS/GetImages
  echo PROP_GetImages_name="$NAME" >> $PROPS/GetImages
  echo Created \'GetImages\' as function \'$NAME\' in function app \'$NAME_default_functionapp\' in $(since $START_TIME)
}

NAME_GetUploadUrl=GetUploadUrl
create-GetUploadUrl() {
  NAME="$NAME_GetUploadUrl"
  echo Creating \'GetUploadUrl\' as function \'$NAME\' in function app \'$NAME_default_functionapp\'...
  local START_TIME=$(date +%s)
  echo PROP_GetUploadUrl_app_defaultHostName="$PROP_default_functionapp_defaultHostName" >> $PROPS/GetUploadUrl
  echo PROP_GetUploadUrl_name="$NAME" >> $PROPS/GetUploadUrl
  echo Created \'GetUploadUrl\' as function \'$NAME\' in function app \'$NAME_default_functionapp\' in $(since $START_TIME)
}

NAME_imageDocuments=images
NAME_imageDocuments_database=imagesdb
NAME_imageDocuments_database_account=imagedocuments-$(hash cosmosdb/imageDocuments@$LOCATION)
create-imageDocuments() {
  NAME="$NAME_imageDocuments"
  NAME_database="$NAME_imageDocuments_database"
  NAME_database_account="$NAME_imageDocuments_database_account"
  echo Creating \'imageDocuments\' as collection \'$NAME\' in cosmos db database \'$NAME_database\' account \'$NAME_database_account\'...
  local START_TIME=$(date +%s)
  ENDPOINT=$(azp imageDocuments cosmosdb create \
    -n "$NAME_database_account" \
    -g "$RESOURCE_GROUP" \
    --query documentEndpoint \
    -o tsv)
  KEY=$(azp imageDocuments cosmosdb list-keys \
    -n "$NAME_database_account" \
    -g "$RESOURCE_GROUP" \
    --query primaryMasterKey \
    -o tsv)
  echo PROP_imageDocuments_database_account_connectionString="AccountEndpoint=$ENDPOINT;AccountKey=$KEY;" >> $PROPS/imageDocuments
  EXISTS=$(azp imageDocuments cosmosdb database exists \
    -n "$NAME_database_account" \
    -g "$RESOURCE_GROUP" \
    --db-name "$NAME_database" \
    -o tsv)
  if [ "$EXISTS" == "false" ]; then
    azp -q imageDocuments cosmosdb database create \
      -n "$NAME_database_account" \
      -g "$RESOURCE_GROUP" \
      --db-name "$NAME_database"
  fi
  echo PROP_imageDocuments_database_name="$NAME_database" >> $PROPS/imageDocuments
  EXISTS=$(azp imageDocuments cosmosdb collection exists \
    -n "$NAME_database_account" \
    -g "$RESOURCE_GROUP" \
    --db-name "$NAME_database" \
    --collection-name "$NAME" \
    -o tsv)
  if [ "$EXISTS" == "false" ]; then
    azp -q imageDocuments cosmosdb collection create \
      -n "$NAME_database_account" \
      -g "$RESOURCE_GROUP" \
      --db-name "$NAME_database" \
      --collection-name "$NAME" \
      --throughput 400
  fi
  echo PROP_imageDocuments_name="$NAME" >> $PROPS/imageDocuments
  echo Created \'imageDocuments\' as collection \'$NAME\' in cosmos db database \'$NAME_database\' account \'$NAME_database_account\' in $(since $START_TIME)
}

NAME_images=images
create-images() {
  NAME="$NAME_images"
  echo Creating \'images\' as container \'$NAME\' in storage account \'$NAME_default_storageAccount\'...
  local START_TIME=$(date +%s)
  azp -q images storage container create \
    -n "$NAME" \
    --account-name "$NAME_default_storageAccount" \
    --public-access blob
  echo PROP_images_primaryEndpoint="$PROP_default_storageAccount_primaryEndpoints_blob" >> $PROPS/images
  echo PROP_images_account_connectionString="$PROP_default_storageAccount_connectionString" >> $PROPS/images
  echo PROP_images_name="$NAME_images" >> $PROPS/images
  echo Created \'images\' as container \'$NAME\' in storage account \'$NAME_default_storageAccount\' in $(since $START_TIME)
}

NAME_ResizeImage=ResizeImage
create-ResizeImage() {
  NAME="$NAME_ResizeImage"
  echo Creating \'ResizeImage\' as function \'$NAME\' in function app \'$NAME_default_functionapp\'...
  local START_TIME=$(date +%s)
  echo PROP_ResizeImage_app_defaultHostName="$PROP_default_functionapp_defaultHostName" >> $PROPS/ResizeImage
  echo PROP_ResizeImage_name="$NAME" >> $PROPS/ResizeImage
  echo Created \'ResizeImage\' as function \'$NAME\' in function app \'$NAME_default_functionapp\' in $(since $START_TIME)
}

NAME_thumbnails=thumbnails
create-thumbnails() {
  NAME="$NAME_thumbnails"
  echo Creating \'thumbnails\' as container \'$NAME\' in storage account \'$NAME_default_storageAccount\'...
  local START_TIME=$(date +%s)
  azp -q thumbnails storage container create \
    -n "$NAME" \
    --account-name "$NAME_default_storageAccount" \
    --public-access blob
  echo PROP_thumbnails_primaryEndpoint="$PROP_default_storageAccount_primaryEndpoints_blob" >> $PROPS/thumbnails
  echo PROP_thumbnails_account_connectionString="$PROP_default_storageAccount_connectionString" >> $PROPS/thumbnails
  echo PROP_thumbnails_name="$NAME_thumbnails" >> $PROPS/thumbnails
  echo Created \'thumbnails\' as container \'$NAME\' in storage account \'$NAME_default_storageAccount\' in $(since $START_TIME)
}

# Creation dependencies:
# - analyzer
# - +functionapp <- +storageAccount
# - +storageAccount
# - frontend <- +storageAccount
# - GetImages <- +functionapp
# - GetUploadUrl <- +functionapp
# - imageDocuments
# - images <- +storageAccount
# - ResizeImage <- +functionapp
# - thumbnails <- +storageAccount

create-analyzer & PID_create_analyzer=$!
sleep 0.1
create-default-storageAccount & PID_create_default_storageAccount=$!
sleep 0.1
create-imageDocuments & PID_create_imageDocuments=$!
sleep 0.1
wait $PID_create_default_storageAccount && readenv $PROPS/default_storageAccount
create-default-functionapp & PID_create_default_functionapp=$!
sleep 0.1
create-frontend & PID_create_frontend=$!
sleep 0.1
create-images & PID_create_images=$!
sleep 0.1
create-thumbnails & PID_create_thumbnails=$!
sleep 0.1
wait $PID_create_default_functionapp && readenv $PROPS/default_functionapp
create-GetImages & PID_create_GetImages=$!
sleep 0.1
create-GetUploadUrl & PID_create_GetUploadUrl=$!
sleep 0.1
create-ResizeImage & PID_create_ResizeImage=$!
wait
readenv $PROPS/analyzer
readenv $PROPS/frontend
readenv $PROPS/GetImages
readenv $PROPS/GetUploadUrl
readenv $PROPS/imageDocuments
readenv $PROPS/images
readenv $PROPS/ResizeImage
readenv $PROPS/thumbnails

#
# PHASE 2: CONFIGURE
#

configure-frontend() {
  echo Configuring \'frontend\' static website...
  local START_TIME=$(date +%s)
  echo 'window.settings = {}' > www/dist/settings.js
  echo 'window.settings.authEnabled = true' >> www/dist/settings.js
  echo Configured \'frontend\' static website in $(since $START_TIME)
}

configure-default-functionapp() {
  echo Configuring default function app...
  local START_TIME=$(date +%s)
  APP_ID=$(azp +functionapp ad app list \
    --identifier-uri "https://$PROP_default_functionapp_defaultHostName" \
    --query '[].appId' \
    -o tsv)
  if [ -z "$APP_ID" ]; then
    APP_ID=$(azp +functionapp ad app create \
      --display-name "First Serverless Web Application" \
      --homepage "https://$PROP_default_functionapp_defaultHostName" \
      --identifier-uris "https://$PROP_default_functionapp_defaultHostName" \
      --reply-urls "https://$PROP_default_functionapp_defaultHostName/.auth/login/aad/callback" \
      --required-resource-accesses '[{
        "resourceAppId": "00000002-0000-0000-c000-000000000000",
        "resourceAccess": [
          {
            "id": "311a71cc-e848-46a1-bdf8-97ff7156d8e6",
            "type": "Scope"
          }
        ]
      }]' \
      --query appId \
      -o tsv)
  fi
  FUNCTIONAPP_AUTH_ENABLE=$(mktemp)
  trap 'rm -f $FUNCTIONAPP_AUTH_ENABLE' EXIT
  cat << EOF > $FUNCTIONAPP_AUTH_ENABLE
.properties.enabled = true |
.properties.runtimeVersion = "1.0.0" |
.properties.unauthenticatedClientAction = "RedirectToLoginPage" |
.properties.tokenStoreEnabled = true |
.properties.allowedExternalRedirectUrls = [ "$PROP_frontend_primaryEndpoint" ] |
.properties.defaultProvider = "AzureActiveDirectory" |
.properties.clientId = "$APP_ID" |
.properties.issuer = "https://sts.windows.net/$(az account show --query tenantId -o tsv)/" |
.properties.allowedAudiences = [ "https://$PROP_default_functionapp_defaultHostName/.auth/login/aad/callback" ] |
.properties.isAadAutoProvisioned = true
EOF
  azp +functionapp resource invoke-action \
    -g "$RESOURCE_GROUP" \
    --namespace Microsoft.Web \
    --parent "sites/$NAME_default_functionapp" \
    --resource-type config \
    -n authsettings \
    --action list \
    --api-version 2018-02-01 \
    -o tsv | \
  jq "$(cat $FUNCTIONAPP_AUTH_ENABLE)" | \
  azp -q +functionapp resource create \
    -g "$RESOURCE_GROUP" \
    --namespace Microsoft.Web \
    --parent "sites/$NAME_default_functionapp" \
    --resource-type config \
    -n authsettings \
    --api-version 2018-02-01 \
    --is-full-object \
    --properties @/dev/stdin
  # TODO: move the CORS rule elsewhere
  azp -q +functionapp resource update \
    -g "$RESOURCE_GROUP" \
    --namespace Microsoft.Web \
    --parent "sites/$NAME_default_functionapp" \
    --resource-type config \
    -n web \
    --api-version 2015-06-01 \
    --set properties.cors.allowedOrigins="['"$PROP_frontend_primaryEndpoint"']"
  echo Configured default function app in $(since $START_TIME)
}

configure-frontend & PID_configure_frontend=$!
sleep 0.1
configure-default-functionapp & PID_configure_default_functionapp=$!
wait

#
# PHASE 3: BIND
#

bind-frontend() {
  echo 'window.settings.default = {}' >> www/dist/settings.js
  echo Binding \'frontend\' static website to \'images\' storage container...
  echo 'window.settings.images = { primaryEndpoint: "'$PROP_images_primaryEndpoint'" }' >> www/dist/settings.js
  echo Binding \'frontend\' static website to default function app...
  echo 'window.settings.default.functionapp = { defaultHostName: "'$PROP_default_functionapp_defaultHostName'" }' >> www/dist/settings.js
}

bind-default-functionapp() {
  echo Binding \'GetImages\' function to \'imageDocuments\' cosmos db collection...
  echo Binding \'GetUploadUrl\' function to \'images\' storage container...
  echo Binding \'ResizeImage\' function to \'images\' storage container...
  echo Binding \'ResizeImage\' function to \'thumbnails\' storage container...
  echo Binding \'ResizeImage\' function to \'imageDocuments\' cosmos db collection...
  echo Binding \'ResizeImage\' function to \'analyzer\' cognitive services account...
  if [ "$LANGUAGE" == "javascript" ]; then
    ENABLE_BUILD="SCM_DO_BUILD_DURING_DEPLOYMENT=true"
  fi
  azp -q +functionapp functionapp config appsettings set -n "$NAME_default_functionapp" -g "$RESOURCE_GROUP" --settings "$ENABLE_BUILD" \
    "ANALYZER_URL=$PROP_analyzer_url" \
    "ANALYZER_KEY=$PROP_analyzer_key" \
    "IMAGE_DOCUMENTS_DATABASE_ACCOUNT_CONNECTION_STRING=$PROP_imageDocuments_database_account_connectionString" \
    "IMAGE_DOCUMENTS_DATABASE_NAME=$PROP_imageDocuments_database_name" \
    "IMAGE_DOCUMENTS_NAME=$PROP_imageDocuments_name" \
    "IMAGES_ACCOUNT_CONNECTION_STRING=$PROP_images_account_connectionString" \
    "IMAGES_NAME=$PROP_images_name" \
    "THUMBNAILS_ACCOUNT_CONNECTION_STRING=$PROP_thumbnails_account_connectionString" \
    "THUMBNAILS_NAME=$PROP_thumbnails_name"
}

bind-frontend & PID_bind_frontend=$!
sleep 0.1
bind-default-functionapp & PID_bind_default_functionapp=$!
wait

#
# PHASE 4: PUSH
#

push-frontend() {
  echo Pushing content to \'frontend\' static website...
  local START_TIME=$(date +%s)
  az storage blob upload-batch \
    --account-name "$NAME_default_storageAccount" \
    --source www/dist \
    --destination \$web \
    --query '[].blob' \
    -o tsv
  az storage blob service-properties update \
    --account-name "$NAME_default_storageAccount" \
    --index-document index.html
  echo Pushed content to \'frontend\' static website in $(since $START_TIME)
}

push-default-functionapp() {
  echo Pushing source for \'GetImages\' function to \'functions\' function app...
  echo Pushing source for \'GetUploadUrl\' function to \'functions\' function app...
  echo Pushing source for \'ResizeImage\' function to \'functions\' function app...
  local START_TIME=$(date +%s)
  PACKAGE_DIR=$(mktemp -d)
  ZIP_FILE=$(mktemp -u).zip
  trap 'rm -rf $PACKAGE_DIR; rm -f $ZIP_FILE' EXIT
  if [ "$LANGUAGE" == "javascript" ]; then
    cp -R "$LANGUAGE/site/"* $PACKAGE_DIR
  fi
  cp -R "$LANGUAGE/GetImages" $PACKAGE_DIR
  cp -R "$LANGUAGE/GetUploadUrl" $PACKAGE_DIR
  cp -R "$LANGUAGE/ResizeImage" $PACKAGE_DIR
  (cd $PACKAGE_DIR && zip -r $ZIP_FILE .)
  az functionapp deployment source config-zip \
    -n "$NAME_default_functionapp" \
    -g "$RESOURCE_GROUP" \
    --src $ZIP_FILE \
    --query message \
    -o tsv
  echo Pushed source for \'GetImages\' function to \'functions\' function app in $(since $START_TIME)
  echo Pushed source for \'GetUploadUrl\' function to \'functions\' function app in $(since $START_TIME)
  echo Pushed source for \'ResizeImage\' function to \'functions\' function app in $(since $START_TIME)
}

push-frontend
push-default-functionapp

#
# COMPLETION
#

echo
echo endpoints:
echo "  "frontend: $PROP_frontend_primaryEndpoint
echo
