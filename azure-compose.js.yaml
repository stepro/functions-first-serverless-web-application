services:
  backingStore:
    storageAccount:
      kind: StorageV2
      httpsOnly: true
      sku: Standard_LRS
      cors:
      - services: [blob]
        methods: [OPTIONS, PUT]
        origins: ["*"]
        allowedHeaders: ["*"]
        exposedHeaders: ["*"]
  images:
    storageContainer:
      account: backingStore
      publicAccess: blob
  thumbnails:
    storageContainer:
      account: backingStore
      publicAccess: blob
  imageDocuments:
    cosmosdbCollection:
      name: images
      database:
      - name: imagesdb
      throughput: 400
  analyzer:
    cognitiveservicesAccount:
      kind: ComputerVision
      sku: F0
  functions:
    functionapp:
      storageAccount: backingStore
      authentication:
        enabled: true
        action: azureActiveDirectoryLogin
        appDisplayName: First Serverless Web Application
        tokenStore: true
        redirectUris:
        - $(frontend:primaryEndpoint)
      cors:
        allowedOrigins:
        - $(frontend:primaryEndpoint)
      postDeploy:
      - npm init -y
      - npm install --save axios azure-storage jimp
  GetImages:
    requires: imageDocuments
    function:
      app: functions
      source: javascript/GetImages
  GetUploadUrl:
    requires: images
    function:
      app: functions
      source: javascript/GetUploadUrl
  ResizeImage:
    requires: [backingStore, imageDocuments, analyzer]
    function:
      app: functions
      source: javascript/ResizeImage
  frontend:
    requires:
      backingStore:
        primaryEndpoints: blob
      functions: true
    staticWebsite:
      account: backingStore
      content: www/dist
      settings:
        authEnabled: true
      index: index.html
endpoints:
  frontend: $(frontend:primaryEndpoint)
